<!DOCTYPE html>
<!--
  История чеков пользователя. Открывается как Mini App из бота.
  SUPABASE_URL и SUPABASE_SERVICE_KEY — в открытом виде для запроса чеков по sender_telegram_id.
-->
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>История чеков</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg: #18222d;
      --block: #242f3d;
      --text: #e4e4e5;
      --hint: #8b959e;
      --divider: #2b3742;
      --green: #3cb878;
      --red: #e53935;
      --yellow: #f5a623;
      --font: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { margin: 0; padding: 0; min-height: 100vh; font-family: var(--font); font-size: 15px; background: var(--bg); color: var(--text); -webkit-font-smoothing: antialiased; }
    body { padding: 16px; padding-top: max(56px, env(safe-area-inset-top)); padding-bottom: env(safe-area-inset-bottom); }
    .page { max-width: 420px; margin: 0 auto; }
    h1 { font-size: 18px; font-weight: 600; margin: 0 0 20px; color: var(--text); }
    .section { margin-bottom: 24px; }
    .section-title { font-size: 12px; text-transform: uppercase; letter-spacing: 0.05em; color: var(--hint); margin-bottom: 8px; }
    .card { background: var(--block); border-radius: 12px; padding: 14px 16px; margin-bottom: 8px; }
    .card-row { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 6px; }
    .card-id { font-weight: 500; color: var(--text); }
    .card-date { font-size: 13px; color: var(--hint); }
    .card-amount { font-weight: 600; color: var(--green); }
    .card-status { font-size: 12px; padding: 2px 8px; border-radius: 6px; }
    .card-status.pending { background: rgba(245, 166, 35, 0.2); color: var(--yellow); }
    .card-status.awaiting { background: rgba(245, 166, 35, 0.2); color: var(--yellow); }
    .card-status.confirmed { background: rgba(60, 184, 120, 0.2); color: var(--green); }
    .card-status.rejected { background: rgba(229, 57, 53, 0.2); color: var(--red); }
    .empty { color: var(--hint); font-size: 14px; padding: 20px 0; text-align: center; }
    .load { text-align: center; color: var(--hint); padding: 24px; }
    .err { color: var(--red); font-size: 14px; padding: 16px; text-align: center; }
  </style>
</head>
<body>
  <div class="page">
    <h1>История чеков</h1>
    <div id="root">
      <div class="load" id="load">Загрузка...</div>
      <div id="content" style="display:none;"></div>
      <div class="err" id="err" style="display:none;"></div>
    </div>
  </div>
  <script>
(function() {
  // В открытом виде: Supabase для запроса чеков по telegram_id
  var SUPABASE_URL = 'https://wzpywfedbowlosmvecos.supabase.co';
  var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6cHl3ZmVkYm93bG9zbXZlY29zIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NjM1MDIzOSwiZXhwIjoyMDgxOTI2MjM5fQ.mzhh4g_DUpwQUtE2_-tGitSCW9ry2WRHYg-f-MSPt1Q';

  function getUserId() {
    try {
      var twa = window.Telegram && window.Telegram.WebApp;
      var user = twa && twa.initDataUnsafe && twa.initDataUnsafe.user;
      if (user && user.id) return user.id;
    } catch (e) {}
    var params = new URLSearchParams(window.location.search);
    return params.get('tg_id') || params.get('user_id') || params.get('user') || null;
  }

  function formatDate(s) {
    if (!s) return '—';
    var d = new Date(s);
    return d.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
  }

  function statusLabel(status) {
    if (status === 'pending') return 'Ожидает проверку';
    if (status === 'awaiting_amount') return 'Ожидает сумму';
    if (status === 'confirmed') return 'Подтверждён';
    if (status === 'rejected') return 'Отклонён';
    return status || '—';
  }

  function statusClass(status) {
    if (status === 'confirmed') return 'confirmed';
    if (status === 'rejected') return 'rejected';
    return status === 'awaiting_amount' ? 'awaiting' : 'pending';
  }

  function render(checks) {
    var pending = checks.filter(function(c) { return c.status === 'pending' || c.status === 'awaiting_amount'; });
    var confirmed = checks.filter(function(c) { return c.status === 'confirmed'; });
    var rejected = checks.filter(function(c) { return c.status === 'rejected'; });

    var html = '';

    html += '<div class="section"><div class="section-title">Ожидают проверку</div>';
    if (pending.length === 0) html += '<div class="empty">Нет чеков</div>';
    else pending.forEach(function(c) {
      html += '<div class="card"><div class="card-row"><span class="card-id">Чек #' + c.id + '</span><span class="card-status ' + statusClass(c.status) + '">' + statusLabel(c.status) + '</span></div><div class="card-date">' + formatDate(c.created_at) + '</div></div>';
    });
    html += '</div>';

    html += '<div class="section"><div class="section-title">Подтверждено</div>';
    if (confirmed.length === 0) html += '<div class="empty">Нет чеков</div>';
    else confirmed.forEach(function(c) {
      var amount = c.amount_usd != null ? '$' + Number(c.amount_usd) : '';
      html += '<div class="card"><div class="card-row"><span class="card-id">Чек #' + c.id + '</span><span class="card-amount">' + amount + '</span></div><div class="card-row"><span class="card-date">' + formatDate(c.confirmed_at || c.created_at) + '</span><span class="card-status confirmed">Подтверждён</span></div></div>';
    });
    html += '</div>';

    html += '<div class="section"><div class="section-title">Отклонено</div>';
    if (rejected.length === 0) html += '<div class="empty">Нет чеков</div>';
    else rejected.forEach(function(c) {
      html += '<div class="card"><div class="card-row"><span class="card-id">Чек #' + c.id + '</span><span class="card-status rejected">Отклонён</span></div><div class="card-date">' + formatDate(c.created_at) + '</div></div>';
    });
    html += '</div>';

    return html;
  }

  function showErr(msg) {
    document.getElementById('load').style.display = 'none';
    document.getElementById('content').style.display = 'none';
    var el = document.getElementById('err');
    el.textContent = msg;
    el.style.display = 'block';
  }

  function showContent(html) {
    document.getElementById('load').style.display = 'none';
    document.getElementById('err').style.display = 'none';
    var el = document.getElementById('content');
    el.innerHTML = html;
    el.style.display = 'block';
  }

  var userId = getUserId();
  if (!userId) {
    showErr('Не передан ID пользователя. Откройте страницу через бота.');
    throw new Error('no user id');
  }

  var url = SUPABASE_URL + '/rest/v1/checks?sender_telegram_id=eq.' + encodeURIComponent(userId) + '&select=id,status,amount_usd,created_at,confirmed_at&order=created_at.desc';
  fetch(url, {
    headers: {
      'apikey': SUPABASE_KEY,
      'Authorization': 'Bearer ' + SUPABASE_KEY,
      'Content-Type': 'application/json'
    }
  })
  .then(function(r) {
    if (!r.ok) throw new Error('Ошибка загрузки');
    return r.json();
  })
  .then(function(data) {
    showContent(render(Array.isArray(data) ? data : []));
  })
  .catch(function(e) {
    showErr(e.message || 'Не удалось загрузить историю.');
  });

  if (window.Telegram && window.Telegram.WebApp) {
    var twa = window.Telegram.WebApp;
    twa.ready();
    twa.expand();
    if (twa.requestFullscreen && typeof twa.requestFullscreen === 'function') try { twa.requestFullscreen(); } catch (_) {}
    twa.setHeaderColor && twa.setHeaderColor('#18222d');
    twa.setBackgroundColor && twa.setBackgroundColor('#18222d');
  }
})();
  </script>
</body>
</html>
